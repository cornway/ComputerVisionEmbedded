/*
 * Copyright (c) 2025 STMicroelectronics
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <st/u5/stm32u5g9Xj.dtsi>
#include <st/u5/stm32u5g7vjtx-pinctrl.dtsi>
#include <zephyr/dt-bindings/display/panel.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <st/u5/stm32u5.dtsi>

/ {
	model = "Grinreflex Development Kit V2.0";
	compatible = "st,stm32u5g9j-dk2";

	chosen {
		zephyr,console = &usart2;
		zephyr,shell-uart = &usart2;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &slot0_partition;
		zephyr,display = &st7735r_160x80;
		zephyr,camera = &zephyr_camera_dvp;
	};

	led_gpios {
		compatible = "gpio-leds";

		green_led_0: led_0 {
			gpios = <&gpiob 11 GPIO_ACTIVE_HIGH>;
			label = "Face detect OK";
		};
	};

	aliases {
		watchdog0 = &iwdg;
		die-temp0 = &die_temp;
		volt-sensor0 = &vref1;
		volt-sensor1 = &vbat4;
		led0 = &green_led_0;
	};

	mipi_dbi_st7735r_160x80 {
		compatible = "zephyr,mipi-dbi-spi";
		spi-dev = <&spi1>;
		dc-gpios = <&gpiob 15 GPIO_ACTIVE_HIGH>;
		#address-cells = <1>;
		#size-cells = <0>;

		st7735r_160x80: st7735r@0 {
			compatible = "sitronix,st7735r";
			mipi-max-frequency = <20000000>;
			mipi-mode = "MIPI_DBI_MODE_SPI_4WIRE";
			reg = <0>;
			width = <160>;
			height = <80>;
			inversion-on;
			rgb-is-inverted;
			x-offset = <1>;
			y-offset = <26>;
			pwctr1 = [A2 02 84];
			pwctr2 = [C5];
			pwctr3 = [0A 00];
			pwctr4 = [8A 2A];
			pwctr5 = [8A EE];
			invctr = <7>;
			frmctr1 = [01 2C 2D];
			frmctr2 = [01 2C 2D];
			frmctr3 = [01 2C 2D 01 2C 2D];
			vmctr1 = <14>;
			gamctrp1 = [02 1C 07 12 37 32 29 2D 29 25 2B 39 00 01 03 10];
			gamctrn1 = [03 1D 07 06 2E 2C 29 2D 2E 2E 37 3F 00 00 02 10];
			colmod = <5>;
			/* Set D3 (RGB) bit to 1. LV_COLOR_16_SWAP is enabled by default */
			madctl = <184>; /* Set to <184> to rotate the image 180 degrees. */
			caset = [00 01 00 a0];
			raset = [00 1a 00 69];
		};
	};

	dcmi_camera_connector: connector_dcmi_camera {
		compatible = "weact,dcmi-camera-connector";
		#gpio-cells = <2>;
		gpio-map-mask = <0xffffffff 0xffffffc0>;
		gpio-map-pass-thru = <0 0x3f>;

		gpio-map = <3  0 &gpiob 14  0>,  /* DVP_SDA (I2C2_SDA)*/
			   <5  0 &gpiob 13  0>,  /* DVP_SCL (I2C2_SCL)*/
			   <7  0 &gpiob 7  0>,  /* DVP_VSYNC*/
			   <8  0 &gpioa 7  0>,  /* DVP_PWDN NC*/
			   <9  0 &gpioa 4  0>,  /* DVP_HSYNC*/
			   <12 0 &gpioe 6  0>,  /* DVP_D7*/
			   <13 0 &gpioa 8  0>,  /* DVP_XCLK (RCC_MCO1)*/
			   <14 0 &gpioe 5  0>,  /* DVP_D6*/
			   <16 0 &gpiob 6  0>,  /* DVP_D5*/
			   <17 0 &gpiod 9  0>,  /* DVP_PCLK*/
			   <18 0 &gpioe 4  0>,  /* DVP_D4*/
			   <19 0 &gpioc 6  0>,  /* DVP_D0*/
			   <20 0 &gpioc 9  0>,  /* DVP_D3 */
			   <21 0 &gpioc 7  0>,  /* DVP_D1 */
			   <22 0 &gpioc 8  0>;  /* DVP_D2 */
	};

};

&clk_hsi48 {
	status = "okay";
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(16)>;
	status = "okay";
};

&pll1 {
	div-m = <4>;
	mul-n = <80>;
	div-p = <2>;
	div-q = <2>;
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&pll2 {
	div-m = <4>;
	mul-n = <66>;
	div-p = <2>;
	div-q = <2>;
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&pll3 {
	div-m = <4>;
	mul-n = <125>;
	div-p = <20>;
	div-q = <20>;
	div-r = <20>;
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll1>;
	clock-frequency = <DT_FREQ_M(160)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <1>;
	apb2-prescaler = <1>;
	apb3-prescaler = <1>;
};

&usart2 {
	pinctrl-0 = <&usart2_tx_pa2 &usart2_rx_pa15>;
	pinctrl-names = "default";
	current-speed = <115200>;
	status = "okay";
};

&i2c1 {
	pinctrl-names = "default";
	pinctrl-0 = <&i2c1_scl_pb8 &i2c1_sda_pb3>;
	status = "disabled";
	clock-frequency = <I2C_BITRATE_FAST>;
};

&i2c2 {
	pinctrl-0 = <&i2c2_scl_pb10 &i2c2_sda_pb14>;
	pinctrl-names = "default";
	status = "okay";
	clock-frequency = <I2C_BITRATE_FAST>;

	ov2640: ov2640@30 {
		compatible = "ovti,ov2640";
		reg = <0x30>;

		supply-gpios = <&dcmi_camera_connector 8 GPIO_ACTIVE_HIGH>;
		clock-rate-control = <0x80>;

		status = "okay";

		port {
			ov2640_ep_out: endpoint {
				remote-endpoint-label = "zephyr_camera_dvp_in";
			};
		};
	};
};

&spi1 {
	pinctrl-0 = <&spi1_sck_pa1 &spi1_mosi_pe15>;
	pinctrl-names = "default";
	cs-gpios = <&gpioe 12 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
	clock-frequency = <DT_FREQ_M(66)>;
	status = "okay";
};

&spi2 {
	pinctrl-0 = <&spi2_sck_pb13 &spi2_mosi_pc1 &spi2_miso_pc2>;
	pinctrl-names = "default";
	cs-gpios = <&gpiob 11 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
	clock-frequency = <DT_FREQ_M(10)>;
	status = "disabled";
};

&timers1 {
	st,prescaler = <1>;
	status = "disabled";

	pwm1: pwm {
		status = "okay";
		pinctrl-0 = <&tim1_ch2_pe11>;
		pinctrl-names = "default";
	};
};

&timers2 {
	st,prescaler = <1>;
	status = "disabled";

	pwm2: pwm {
		status = "okay";
		pinctrl-0 = <&tim2_ch4_pa3>;
		pinctrl-names = "default";
	};
};

/* Connected to onboard 4-Gbyte eMMC flash memory */
&sdmmc1 {
	pinctrl-0 = <&sdmmc1_d0_pc8 &sdmmc1_d1_pc9
		&sdmmc1_d2_pc10 &sdmmc1_d3_pc11
		&sdmmc1_d4_pb8 &sdmmc1_d5_pb9
		&sdmmc1_d6_pc6 &sdmmc1_d7_pc7
		&sdmmc1_ck_pc12 &sdmmc1_cmd_pd2>;
	pinctrl-names = "default";
	/* disabled due to conflicting pins pc6, pc7, pc8
	 * pc9 and pb9 with LTDC node.
	 */
	status = "disabled";
};

&gpdma1 {
	status = "okay";
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/*
		 * Following flash partition is dedicated to the use of bootloader
		 */
		boot_partition: partition@0 {
			label = "mcuboot";
			reg = <0x00000000 DT_SIZE_K(64)>;
		};

		slot0_partition: partition@10000 {
			label = "image-0";
			reg = <0x00010000 DT_SIZE_K(1952)>;
		};

		slot1_partition: partition@1f8000 {
			label = "image-1";
			reg = <0x001f8000 DT_SIZE_K(1960)>;
		};

		storage_partition: partition@3e2000 {
			label = "storage";
			reg = <0x003e2000 DT_SIZE_K(120)>;
		};
	};
};

&rtc {
	clocks =  <&rcc STM32_CLOCK_BUS_APB3 0x00200000>,
			  <&rcc STM32_SRC_LSE RTC_SEL(1)>;
	status = "okay";
};

&iwdg {
	status = "disabled";
};

&rng {
	status = "disabled";
};

&die_temp {
	status = "disabled";
};

&vref1 {
	status = "disabled";
};

&vbat4 {
	status = "disabled";
};


&gpiod {
	status = "okay";

	lcd_led {
		gpio-hog;
		gpios = <8 GPIO_ACTIVE_LOW>;
		output-high;
	};
};

zephyr_camera_dvp: &dcmi {
	pinctrl-0 = <&dcmi_hsync_pa4
				&dcmi_pixclk_pd9
				&dcmi_vsync_pb7
		     	&dcmi_d0_pc6
				&dcmi_d1_pc7
				&dcmi_d2_pc8
				&dcmi_d3_pc9
		     	&dcmi_d4_pe4
				&dcmi_d5_pb6
				&dcmi_d6_pe5
				&dcmi_d7_pe6>;
	pinctrl-names = "default";

	port {
		zephyr_camera_dvp_in: endpoint {
			remote-endpoint-label = "ov2640_ep_out";
			bus-width = <8>;
			hsync-active = <0>;
			vsync-active = <0>;
			pclk-sample = <1>;
		};
	};
	status = "okay";
};

/* See reference manual (RM0456 Rev 6) page 390:
 *   1000: HSI48 clock selected (hsi48_ck)
 */
#define MCO1_SEL_HSI48 8

 /* See reference manual (RM0456 Rev 6) page 520:
  *   010: division by 4
  */
#define MCO1_PRE_DIV_4 2

&mco1 {
	status = "okay";
	clocks = <&rcc STM32_SRC_HSI48 MCO1_SEL(MCO1_SEL_HSI48)>;
	prescaler = <MCO1_PRE(MCO1_PRE_DIV_4)>;
	pinctrl-0 = <&rcc_mco_pa8>;
	pinctrl-names = "default";
};
